# Formula 1 2026 Prediction Engine - Configuration

# Paths
paths:
  data_dir: "data"
  processed: "data/processed"
  raw: "data/raw"
  driver_chars: "data/processed/driver_characteristics.json"
  track_chars: "data/processed/track_characteristics.json"
  lineups: "data/current_lineups.json"
  cache: ".fastf1_cache"

# Bayesian Model Parameters
bayesian:
  # Process noise injected between races to prevent overconfidence
  base_volatility: 0.1

  # Observation noise (higher = trust observations less)
  base_observation_noise: 2.0

  # Shock detection threshold (std devs)
  shock_threshold: 2.0

  # Shock multiplier for concept drift
  shock_multiplier: 0.5

# Race Simulation Parameters
race:
  # Component weights
  weights:
    pace_weight: 0.4
    grid_weight: 0.3
    overtaking_weight: 0.15
    tire_deg_weight: 0.15

  # Base uncertainty (positions)
  base_uncertainty: 2.5

  # Uncertainty multipliers
  uncertainty_multipliers:
    rain: 1.5
    easy_overtaking: 0.8

  # Reliability
  dnf:
    base_risk: 0.05
    driver_error_factor: 0.15
    street_circuit_risk: 0.05
    rain_risk: 0.10

  # Lap 1 chaos
  lap1:
    midfield_variance: 1.5  # Positions 8-15
    front_row_variance: 0.0  # P1-P2 usually hold

  # Tire degradation
  tire:
    # Converts deg_factor to position penalty
    degradation_multiplier: 4.0
    skill_reduction_factor: 0.2

  # Weather impact
  weather:
    rain_position_swing: 6.0  # Good drivers gain 3, bad lose 3
    mixed_intensity: 0.5

  # Safety car
  safety_car:
    compression_factor: 0.1

  # Pace calculation
  pace:
    # Converts FP2 pace delta to position gain potential
    pace_delta_multiplier: 3.0

  # DNF handling
  dnf_position_penalty: 22  # Position penalty for DNF (grid size + 2)

# Qualifying Prediction Parameters
qualifying:
  # Blend weights (practice vs model)
  blend:
    default: 0.7
    fp3_only: 0.8
    fp1_only: 0.4

  # Session confidence weights
  session_confidence:
    fp1: 0.2
    fp2: 0.5
    fp3: 0.9
    sprint_quali: 0.85

  # Uncertainty
  base_uncertainty: 1.5

# Learning System Parameters
learning:
  # Rolling average window for method performance
  performance_window: 5

  # Min races before trusting a method
  min_samples: 3

# Track Characteristics
track_defaults:
  pit_stop_loss: 22.0  # seconds
  safety_car_prob: 0.3
  overtaking_difficulty: 0.5

# Logging
logging:
  level: "INFO"
  format: "%(asctime)s | %(levelname)s | %(message)s"

# Baseline 2026 Predictor Parameters (used before real season data)
baseline_predictor:
  # Qualifying simulation parameters
  qualifying:
    # Qualifying noise standard deviation (random variation)
    noise_std_sprint: 0.030    # Sprint weekends (less practice data)
    noise_std_normal: 0.026    # Normal weekends

    # Score composition weights
    team_weight: 0.66          # Car remains dominant, but less deterministic
    skill_weight: 0.34         # Driver one-lap signal (pace+skill)

    # Compress team spread before scoring.
    # 1.0 = raw team deltas, lower = closer field.
    team_strength_compression: 0.52

    # Driver signal composition for qualifying
    driver_quali_pace_weight: 0.70
    driver_skill_weight: 0.30

    # Extra teammate divergence for setup/execution differences
    teammate_setup_std: 0.018
    driver_offset_cap: 0.12
    driver_signal_softness: 0.20
    weekend_form_std: 0.0
    model_only_team_weight_multiplier: 0.82
    model_only_skill_weight_multiplier: 1.35
    model_only_team_compression_multiplier: 0.87
    model_only_driver_offset_cap_multiplier: 1.33
    model_only_driver_signal_shrink: 0.35
    model_only_experience_shrink:
      rookie: 0.45
      developing: 0.20
      unknown: 0.30
    model_only_noise_multiplier: 1.12
    model_only_teammate_setup_multiplier: 1.10
    model_only_weekend_form_multiplier: 1.0

    # Program-aware testing/practice modifier
    # Uses short-run profile characteristics to make a small team-strength adjustment.
    testing_short_run_modifier_scale: 0.04
    preferred_short_run_compound: "SOFT"

    # FP blend controls
    fp_blend_weight: 0.70
    fp_blend_weight_testing: true

    # Confidence / fallback defaults
    confidence_cap: 60
    confidence_min: 40
    default_skill: 0.5
    default_team_strength: 0.5

    # Track-specific FP driver adjustment
    enable_driver_fp_adjustment: true
    driver_fp_adjustment_scale: 0.10
    driver_fp_adjustment_smoothing: 0.5

  # Compound selection parameters
  compound_selection:
    # Tire stress thresholds for compound selection (based on Pirelli data)
    high_stress_threshold: 3.5    # Above this: HARD compound (Bahrain, Singapore, Hungary)
    low_stress_threshold: 2.5     # Below this: SOFT compound (Monaco, Canada)
    default_stress_fallback: 3.0  # Default if stress metric missing (neutral)

  # Race simulation parameters
  race:
    # Defaults when an active-lineup driver is missing from characteristics
    default_experience_tier: developing
    missing_driver_teammate_weight: 0.75
    missing_driver_default_dnf_rate: 0.10
    missing_driver_rookie_dnf_penalty: 0.02
    missing_driver_rookie_quali_penalty: 0.08
    missing_driver_rookie_race_penalty: 0.07
    missing_driver_rookie_skill_penalty: 0.08
    missing_driver_rookie_overtaking_penalty: 0.06

    # Weather-based base chaos (unpredictability)
    # Reduced from 0.35 to improve realism and reduce tail variance
    base_chaos:
      dry: 0.28                 # Dry conditions chaos level (down from 0.35)
      wet: 0.42                 # Wet conditions chaos level (down from 0.45)

    # Track chaos modifier
    # Harder to overtake (higher overtaking_difficulty) = lower chaos
    # Monaco (0.9) → 0.64x, Monza (0.2) → 0.92x
    track_chaos_multiplier: 0.4 # Multiplier applied to track overtaking difficulty

    # Safety car probabilities
    sc_base_probability:
      dry: 0.45                # Base safety car probability in dry
      wet: 0.70                # Base safety car probability in wet
    sc_track_modifier: 0.25    # Additional probability per overtaking difficulty

    # Grid position advantage
    grid_weight_min: 0.15      # Minimum grid weight (even on overtaking tracks)
    grid_weight_multiplier: 0.35  # Additional weight per track overtaking difficulty
                                  # Range: 0.15 (Monza) to 0.50 (Monaco)
    grid_divisor: 21           # Total grid size for normalization

    # Position scaling by grid slot (race-pace/overtake boost dampening)
    position_scaling:
      front_threshold: 3
      front_scale: 0.10
      upper_threshold: 7
      upper_scale: 0.30
      mid_threshold: 12
      mid_scale: 0.60
      back_scale: 1.00

    # Systematic race pace advantage
    # Drivers better in races (Alonso, Hamilton) vs quali specialists
    # Reduced from 0.5 → 0.15 to prevent unrealistic comebacks from midfield
    race_advantage_multiplier: 0.15  # Max ±0.15 swing from race_advantage

    # Overtaking skill boost
    # Only applies to drivers starting >5th on easy overtaking tracks (<0.5 difficulty)
    overtaking_skill_multiplier: 0.25  # Multiplier for (overtaking_skill - 0.5)
    overtaking_grid_threshold: 5       # Grid position threshold (>= this)
    overtaking_track_threshold: 0.5    # Track overtaking difficulty threshold (<= this)

    # Lap 1 chaos by grid position (random incidents/battles)
    # Reduced lap 1 chaos to improve front-runner stability
    lap1_chaos:
      front_row: 0.10          # P1-P3: safer, fewer battles (down from 0.15)
      upper_midfield: 0.28     # P4-P10: competitive battles (down from 0.32)
      midfield: 0.35           # P11-P15: most chaotic (down from 0.38)
      back_field: 0.25         # P16+: fewer competitors (down from 0.28)

    # Strategy variance
    # Less variance on Monaco (follow leader strategy), more on Bahrain
    strategy_variance_base: 0.30       # Base standard deviation
    strategy_track_modifier: 0.5       # Multiplier based on track overtaking
                                       # Monaco: 0.17, Bahrain: 0.24

    # Safety car luck (position swing when safety car deployed)
    safety_car_luck_range: 0.25  # Uniform range: ±0.25

    # Pace weight in race scoring
    pace_weight_base: 0.40      # Base pace weight
    pace_weight_track_modifier: 0.10  # Reduced weight per track overtaking difficulty
                                      # Range: 0.30 (Monza) to 0.40 (Monaco)

    # Intra-team variance
    # Setup/tire choices vary between teammates
    # Reduced to improve consistency and reduce tail variance
    teammate_variance_std: 0.13 # Standard deviation of teammate variance (down from 0.16)

    # DNF rate caps
    dnf_rate_historical_cap: 0.20  # Cap on historical DNF rate before team uncertainty adjustment
    dnf_rate_final_cap: 0.35       # Final maximum DNF probability per driver

    # Program-aware testing/practice modifier
    # Uses long-run profile characteristics to make a small team-strength adjustment.
    testing_long_run_modifier_scale: 0.05
    weekend_long_run_min_laps: 12     # Minimum stint length to treat laps as race-sim long run
    long_run_outlier_threshold: 1.5
    long_run_trim_ends: true

    # Shared testing profile configuration
    testing_profile_weights:
      short_run:
        overall_pace: 0.55
        top_speed: 0.20
        medium_corner_performance: 0.15
        fast_corner_performance: 0.10
      long_run:
        overall_pace: 0.50
        tire_deg_performance: 0.35
        consistency: 0.15
      balanced:
        overall_pace: 0.65
        tire_deg_performance: 0.20
        top_speed: 0.15

    # Bounds and thresholds for testing/profile modifiers and compound data reliability
    testing_modifier_clip_range: [-0.04, 0.04]
    min_laps_for_compound_data: 10

    # DNF and defensive-skill calibration
    team_uncertainty_dnf_multiplier: 0.20
    defensive_skill_weights:
      overtaking_component: 0.65
      skill_component: 0.35

    # Lap-by-lap simulation controls
    safety_car_trigger_lap: 10

    # Lap-by-lap overtaking model
    overtake_model:
      # Position-zone scaling (target car position) for pass realism:
      # harder at the front, easier in midfield/backfield.
      zone_front_threshold_boost: 0.22
      zone_upper_threshold_boost: 0.10
      zone_mid_threshold_boost: 0.02
      zone_back_threshold_boost: -0.03

      zone_front_probability_scale: 0.55
      zone_upper_probability_scale: 0.75
      zone_mid_probability_scale: 0.92
      zone_back_probability_scale: 1.08

      zone_front_bonus_scale: 0.55
      zone_upper_bonus_scale: 0.78
      zone_mid_bonus_scale: 0.93
      zone_back_bonus_scale: 1.05

    # Pit stop configuration
    pit_stops:
      loss_duration: 22.0              # seconds (track average pit stop time loss)
      overtake_loss_range: [0, 3]      # extra seconds if overtaken during stop (uniform random)

    # Tire strategy configuration
    tire_strategy:
      windows:
        one_stop: [23, 37]             # lap range for 1-stop window (60-lap race baseline)
        two_stop_first: [15, 25]       # first stop window for 2-stop strategy
        two_stop_second: [35, 45]      # second stop window for 2-stop strategy

      stop_probability:
        high_stress_2stop: 0.80        # >3.5 tire stress: 80% chance of 2-stop
        medium_stress_1stop: 0.90      # 2.5-3.5 tire stress: 90% chance of 1-stop
        low_stress_1stop: 0.95         # <2.5 tire stress: 95% chance of 1-stop

      compound_preferences:
        SOFT: 1.0                      # preference weight (higher = more likely)
        MEDIUM: 0.8
        HARD: 0.6

    # Fuel effect configuration
    fuel:
      effect_per_lap: 0.035            # seconds per lap per 10kg fuel
      initial_load_kg: 110             # starting fuel load for 60-lap race
      burn_rate_kg_per_lap: 1.5        # fuel consumption per lap
      deg_multiplier: 0.10             # 10% worse tire deg when fully fueled

    # Tire degradation and fresh tire effects
    tire_physics:
      fresh_tire_advantage:
        SOFT: 0.5                      # seconds/lap advantage for fresh SOFT tires
        MEDIUM: 0.3                    # seconds/lap advantage for fresh MEDIUM tires
        HARD: 0.1                      # seconds/lap advantage for fresh HARD tires

      fresh_tire_duration:
        SOFT: 3                        # laps that fresh tire advantage lasts
        MEDIUM: 3
        HARD: 2

      default_deg_slope: 0.15          # default tire_deg_slope if missing data
      traffic_deg_penalty: 0.05        # 5% worse tire life in dirty air (P16+)
      clean_air_bonus: 0.05            # 5% better tire life for leaders (P1-P5)

    # Lap time modeling
    lap_time:
      reference_base: 90.0             # baseline lap time (seconds) - generic
      team_pace_penalty_range: 5.0    # worst team is +5.0s slower than best
      skill_improvement_max: 0.35      # max lap time improvement from driver skill (up from 0.30)
      team_strength_compression: 0.40  # compress car spread in race pace conversion
      elite_skill_threshold: 0.88      # only exceptional drivers get extra race-craft pace bonus
      elite_skill_lap_bonus_max: 0.22  # max additional sec/lap improvement at skill=1.0 (up from 0.15)
      elite_skill_exponent: 1.30       # non-linear curve for elite-only uplift
      bounds: [70.0, 120.0]            # min/max lap time clamps (safety)

    # Driver race-pace signal impact per lap (higher = more racecraft influence)
    race_advantage_lap_impact: 0.20

    # Final ranking blend after lap-by-lap simulation
    # Increased grid anchor to better preserve qualifying order and reduce tail variance
    grid_anchor:
      base: 0.40                        # Up from 0.32 - stronger grid influence
      track_scale: 0.35                 # Unchanged - track difficulty still matters
      min: 0.70                         # New - minimum anchor for normal races
      sprint_min: 0.78                  # Kept - sprint races preserve grid more

    final_blend:
      overtaking_skill_scale: 1.0       # Down from 1.3 - reduce driver adjustment magnitude
      race_advantage_scale: 0.8         # Down from 1.0 - moderate race pace impact
      driver_skill_scale: 0.6           # Down from 0.7 - reduce skill adjustment
      elite_driver_skill_threshold: 0.88
      elite_driver_scale: 1.2           # Down from 1.6 - less extreme elite advantage
      elite_driver_exponent: 1.35
      max_driver_adjustment_positions: 1.5  # Down from 2.0 - cap position swings
      # Hard cap on total gains from starting position.
      # Prevents unrealistic outcomes such as P22 -> P1 in a normal race.
      max_gain_base: 6.0
      max_gain_track_scale: 4.0
      max_gain_overtaking_skill_scale: 2.0
      max_gain_race_advantage_scale: 2.5
      max_gain_floor: 4.0
      max_gain_ceiling: 11.0

    # Pit strategy constraints
    strategy_constraints:
      min_pit_lap: 5                   # earliest lap for pit stop
      max_pit_lap_from_end: 5          # don't pit in last N laps
      min_laps_between_stops: 8        # minimum stint length (consecutive stops)

      pit_lap_variance:
        one_stop: 3.0                  # ±3 lap variance for 1-stop window
        two_stop: 2.0                  # ±2 lap variance for 2-stop windows

      strategy_optimality: 0.60        # 60% optimal, 40% suboptimal (realism)

  # Dashboard auto-capture settings for completed FP sessions
  practice_capture:
    new_weight: 0.35
    directionality_scale: 0.08
    session_aggregation: "laps_weighted"
    run_profile: "balanced"

  # Compound characteristics blend weights
  # How much to weight new session data vs existing compound data
  compound_blend_weights:
    # Practice sessions (exploratory, varied fuel loads)
    practice: 0.30              # 30% new, 70% existing
    # Sprint race (competitive but short)
    sprint: 0.50                # 50% new, 50% existing
    # Main race (most reliable, full commitment)
    race: 0.70                  # 70% new, 30% existing

# Testing
testing:
  seed: 42
  monte_carlo_runs: 100
