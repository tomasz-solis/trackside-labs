# Weekend Cascade Predictions

Full weekend prediction flow for sprint and normal race weekends.

## Overview

The system predicts **all competitive sessions** for a weekend, not just the final race. This allows you to:
- See how the weekend unfolds step-by-step
- Make F1 Fantasy decisions after each session
- Use actual results when sessions complete (ACTUAL vs PREDICTED grids)

## Weekend Types

### Normal Weekend (Most Races)

**Flow:** Qualifying ‚Üí Race

**Dashboard Output:**
1. **Qualifying Prediction** - Starting grid for Sunday
2. **Race Prediction** - Final classification

**Sessions:**
- FP1, FP2, FP3 (Friday-Saturday) - Telemetry only, grids not used
- Qualifying (Saturday) - Sets race grid
- Race (Sunday) - Main event

### Sprint Weekend (6 races in 2026)

**Flow:** Sprint Quali ‚Üí Sprint Race ‚Üí Main Quali ‚Üí Main Race

**Dashboard Output:**
1. **Sprint Qualifying Prediction** - Friday evening grid
2. **Sprint Race Prediction** - Saturday sprint results
3. **Main Qualifying Prediction** - Saturday evening grid
4. **Main Race Prediction** - Sunday race results

**Sessions:**
- FP1 (Friday) - Only 60 minutes! Limited data
- Sprint Qualifying (Friday) - Short quali format
- Sprint Race (Saturday) - ~30 laps, ~100km
- Main Qualifying (Saturday) - Full quali format
- Main Race (Sunday) - Full Grand Prix

## Grid Source Tracking

Each prediction shows where the starting grid came from:

**ACTUAL (‚úÖ)**
- Fetched from FastF1 after session completes
- Real competitive session results
- Used for: Sprint Quali, Sprint Race, Main Quali grids

**PREDICTED (‚ÑπÔ∏è)**
- Generated by model when session not yet complete
- Based on car characteristics + track suitability
- Falls back to this if FastF1 fetch fails

## Cascade Logic

### Sprint Weekend Cascade

```python
# 1. Predict Sprint Qualifying
sprint_quali_grid = predict_qualifying()

# 2. Predict Sprint Race (uses SQ grid)
if sprint_quali_completed:
    sprint_quali_grid = fetch_actual_results("SQ")  # Use ACTUAL
sprint_race_results = predict_sprint_race(sprint_quali_grid)

# 3. Predict Main Qualifying
main_quali_grid = predict_qualifying()

# 4. Predict Main Race (uses Main Quali grid)
if main_quali_completed:
    main_quali_grid = fetch_actual_results("Q")  # Use ACTUAL
main_race_results = predict_race(main_quali_grid)
```

**Key Point:** Each prediction feeds into the next. Sprint Race uses Sprint Quali grid. Main Race uses Main Quali grid.

### Normal Weekend Cascade

```python
# 1. Predict Qualifying
quali_grid = predict_qualifying()

# 2. Predict Race (uses Quali grid)
if quali_completed:
    quali_grid = fetch_actual_results("Q")  # Use ACTUAL
race_results = predict_race(quali_grid)
```

## Sprint Race Adjustments

Sprint races are shorter and different from full GPs:

**Adjusted Chaos Model:**
- 30% less variance (less time for positions to shuffle)
- Grid position +10% importance (harder to overtake in 30 laps)
- Tire deg reduced (shorter stint)
- Pit stop probability: 5% (rarely happens)

**Why Different?**
- Sprint: ~30 laps, ~30 minutes, 100km
- Full Race: ~50-70 laps, ~90-120 minutes, 305km
- Less time = less chaos, grid matters more

## Practice Sessions (FP1/FP2/FP3)

**What they're used for:**
- Extract team telemetry (sector times, speed traps)
- Blend with model: 70% practice data + 30% model baseline
- Update confidence scores

**What they're NOT used for:**
- Grid order (fuel loads vary, not representative)
- Direct predictions (testing programs, not racing)

**Practice data improves predictions progressively:**
- Pre-FP1: Baseline only (30% confidence)
- Post-FP1: Initial data (50% confidence)
- Post-FP2: Race sim data (70% confidence)
- Post-FP3: Quali sim data (85% confidence)

## Competitive vs Practice Sessions

**Competitive (Setup Locked):**
- Sprint Qualifying (SQ)
- Sprint Race
- Main Qualifying (Q)
- Main Race (R)
- Results are official, used as grid inputs

**Practice (Testing):**
- FP1, FP2, FP3
- Variable fuel, engine modes, tire compounds
- Telemetry extracted, grids ignored

## Implementation Details

### Files

**[src/utils/actual_results_fetcher.py](../src/utils/actual_results_fetcher.py)**
- `fetch_actual_session_results()` - Fetches from FastF1
- `is_competitive_session_completed()` - Checks if session done
- Only works for competitive sessions (SQ, Sprint, Q, R)

**[app.py](../app.py) - Key Functions**
- `run_prediction()` - Returns dict with 2 or 4 predictions
- `fetch_grid_if_available()` - Helper for ACTUAL vs PREDICTED
- `display_prediction_result()` - Shows single prediction with indicators

### Return Format

**Normal Weekend:**
```python
{
    "qualifying": {
        "grid": [...],
        "grid_source": "PREDICTED" | "ACTUAL",
        "data_source": "FP3 + Model",
        "blend_used": True,
        "timing": {...}
    },
    "race": {
        "finish_order": [...],
        "grid_source": "PREDICTED" | "ACTUAL",
        "timing": {...}
    }
}
```

**Sprint Weekend:**
```python
{
    "sprint_quali": {"grid": [...], "grid_source": "..."},
    "sprint_race": {"finish_order": [...], "grid_source": "..."},
    "main_quali": {"grid": [...], "grid_source": "..."},
    "main_race": {"finish_order": [...], "grid_source": "..."}
}
```

## Error Handling

**FastF1 API Failures:**
- Try/except around all FastF1 calls
- Falls back to PREDICTED grid on failure
- Logs errors with context

**Session Not Completed:**
- `is_competitive_session_completed()` returns False
- Uses model-generated grid
- Shows "‚ÑπÔ∏è Using PREDICTED grid"

**Missing Data:**
- Empty results ‚Üí graceful degradation
- Missing driver fields ‚Üí skip driver, log warning
- Invalid positions ‚Üí use index + 1

## Prediction Tracking Integration

When accuracy tracking is enabled:

**Normal Weekend:**
- Saves qualifying grid + race results
- Logged after FP1, FP2, FP3, or Quali
- Max 1 prediction per session

**Sprint Weekend:**
- Saves main_quali grid + main_race results (final predictions only)
- Logged after FP1, SQ, or Sprint
- Max 1 prediction per session
- Sprint Quali and Sprint Race predictions shown but not tracked separately

**Why Track Only Final Predictions?**
- Avoid data explosion (4 predictions √ó 6 sprint weekends = 24 files)
- Main race is what matters for F1 Fantasy
- Sprint quali/race shown for context but not scored

## Usage

### Dashboard

1. Open dashboard: `streamlit run app.py`
2. Select race (sprint indicator shown: "Race Name (Sprint)")
3. Choose weather
4. Click "Generate Prediction"
5. View cascade:
   - Sprint weekend: 4 predictions
   - Normal weekend: 2 predictions

### Example Output

**Sprint Weekend Display:**
```
üèÉ Sprint Weekend Cascade
Full weekend flow: Sprint Qualifying ‚Üí Sprint Race ‚Üí Main Qualifying ‚Üí Main Race

üèÅ Sprint Qualifying Prediction
‚úÖ Using ACTUAL grid from completed session
[Grid P1-P20]

üèéÔ∏è Sprint Race Prediction
‚úÖ Using ACTUAL grid from completed session
[Results with DNF risk, podium probabilities]

üèÅ Main Qualifying Prediction
‚ÑπÔ∏è Using PREDICTED grid
[Grid P1-P20]

üèéÔ∏è Main Race Prediction
‚ÑπÔ∏è Using PREDICTED grid
[Results with DNF risk, podium probabilities]
```

## Known Limitations

1. **Cannot test ACTUAL grid fetching until 2026 sessions complete**
   - Feature ready, awaiting real 2026 data
   - Will work when sessions happen

2. **Practice session grids never used**
   - By design - they're not representative
   - Only telemetry used (70/30 blend)

3. **Sprint race uses simplified model**
   - Adjusted for shorter format
   - Less chaos, grid more important

## Related Documentation

- [FP_BLENDING_SYSTEM.md](FP_BLENDING_SYSTEM.md) - How practice data improves predictions
- [PREDICTION_TRACKING.md](PREDICTION_TRACKING.md) - Accuracy measurement system
- [DASHBOARD_AUTO_UPDATE.md](DASHBOARD_AUTO_UPDATE.md) - Automatic data updates
